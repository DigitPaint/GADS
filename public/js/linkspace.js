!function(){"use strict";Array.prototype.filter||(Array.prototype.filter=function(e){if(null==this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var a,i=[],o=arguments[1],r=0;r<n;r++){r in t&&(a=t[r],e.call(o,a,r,t)&&i.push(a))}return i}),Array.prototype.find||(Array.prototype.find=function(e){if(null==this)throw TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var a=arguments[1],i=0;i<n;){var o=t[i];if(e.call(a,o,i,t))return o;i++}}),"function"!=typeof Array.prototype.forEach&&(Array.prototype.forEach=function(e){for(var t=0;t<this.length;t++)e.apply(this,[this[t],t,this])}),Array.prototype.includes||(Array.prototype.includes=function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),a=n.length>>>0;if(0==a)return!1;for(var i,o,r=0|t,l=Math.max(0<=r?r:a-Math.abs(r),0);l<a;){if((i=n[l])===(o=e)||"number"==typeof i&&"number"==typeof o&&isNaN(i)&&isNaN(o))return!0;l++}return!1}),Array.prototype.map||(Array.prototype.map=function(e){if(null==this)throw TypeError();var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw TypeError();var a=[];a.length=n;for(var i=arguments[1],o=0;o<n;o++)o in t&&(a[o]=e.call(i,t[o],o,t));return a}),Array.prototype.some||(Array.prototype.some=function(e,t){if(null==this)throw new TypeError("Array.prototype.some called on null or undefined");if("function"!=typeof e)throw new TypeError;for(var n=Object(this),a=n.length>>>0,i=0;i<a;i++)if(i in n&&e.call(t,n[i],i,n))return!0;return!1}),Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");function t(){}function n(){return i.apply(this instanceof t&&e?this:e,a.concat(Array.prototype.slice.call(arguments)))}var a=Array.prototype.slice.call(arguments,1),i=this;return t.prototype=this.prototype,n.prototype=new t,n}),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw TypeError("Object.keys called on non-object");var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push(t);return n});var t=$.fn.datepicker;$.fn.datepicker=function(){var e=t.apply(this,arguments);return this.on("show",function(){var e=$(this),t=e.data("datepicker").picker,n=t.hasClass("datepicker-orient-top")?e.offset().top-t.outerHeight()-parseInt(t.css("marginTop")):e.offset().top+e.outerHeight()+parseInt(t.css("marginTop"));t.offset({top:n})}),e};var n=function(e){!function(e){$("a[role=button]",e).on("keypress",function(e){32===e.keyCode&&this.click()});var i=$(".navbar-fixed-bottom",e);i.length&&$(".edit-form .form-group",e).on("focusin",function(e){var t=$(e.target),n=t.offset().top+t.outerHeight(),a=i.offset().top;a<n&&$("html, body").animate({scrollTop:$(window).scrollTop()+n-a+20},300)})}(e)};function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(t,e){var n,a=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)),a}function l(i){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?a(Object(o),!0).forEach(function(e){var t,n,a;t=i,a=o[n=e],n in t?Object.defineProperty(t,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[n]=a}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))})}return i}var c,i,o=(i=[{type:"equal",accept_values:!0,apply_to:["string","number","datetime"]},{type:"not_equal",accept_values:!0,apply_to:["string","number","datetime"]},{type:"less",accept_values:!0,apply_to:["string","number","datetime"]},{type:"less_or_equal",accept_values:!0,apply_to:["string","number","datetime"]},{type:"greater",accept_values:!0,apply_to:["string","number","datetime"]},{type:"greater_or_equal",accept_values:!0,apply_to:["string","number","datetime"]},{type:"contains",accept_values:!0,apply_to:["datetime","string"]},{type:"not_contains",accept_values:!0,apply_to:["datetime","string"]},{type:"begins_with",accept_values:!0,apply_to:["string"]},{type:"not_begins_with",accept_values:!0,apply_to:["string"]},{type:"is_empty",accept_values:!(c={input:"select",values:{b_red:"Red",c_amber:"Amber",c_yellow:"Yellow",d_green:"Green",a_grey:"Grey",e_purple:"Purple"}}),apply_to:["string","number","datetime"]},{type:"is_not_empty",accept_values:!1,apply_to:["string","number","datetime"]},{type:"changed_after",nb_inputs:1,accept_values:!0,multiple:!1,apply_to:["string","number","datetime"]}],function(e){$('script[id^="builder_json_"]',e).each(function(e,t){d(t)}),$(document,e).on("input",".typeahead_text",function(){var e=$(this).val();$(this).next(".typeahead_hidden").val(e)})});function s(e,t){return l({id:t.filterId,label:t.label,type:"string",operators:function(e){if(["date","daterange"].includes(e)){var t=["equal","not_equal","less","less_or_equal","greater","greater_or_equal","is_empty","is_not_empty"];return"daterange"===e&&t.push("contain"),t}}(t.type)},"rag"===t.type?c:t.hasFilterTypeahead?(a=t.urlSuffix,i=e.layoutId,o=t.instanceId,{input:function(e,t,n){return'<input class="typeahead_text" type="text" name="'.concat(n,'_text">\n      <input class="typeahead_hidden" type="hidden" name="').concat(n,'"></input>')},valueSetter:function(e,t,n,a,i){e.find(".typeahead_text").val(i.text),e.find(".typeahead_hidden").val(t)},onAfterCreateRuleInput:function(e){var t=$("#".concat(e.attr("id"),' .rule-value-container input[type="text"]')),n=$("#".concat(e.attr("id"),' .rule-value-container input[type="hidden"]'));t.attr("autocomplete","off"),t.typeahead({delay:100,matcher:function(){return!0},sorter:function(e){return e},afterSelect:function(e){"object"===r(e)?n.val(e.id):n.val(e)},source:function(e,t){return $.ajax({type:"GET",url:"/".concat(i,"/match/layout/").concat(a),data:{q:e,oi:o},success:function(e){t(e)},dataType:"json"})}})}}):{});var a,i,o}function d(e){var t=JSON.parse($(e).html());t.filterNotDone&&(window.UpdateFilter=function(e){var t=e.queryBuilder("getRules");$("#filter").val(JSON.stringify(t,null,2))}),$("#builder".concat(t.builderId)).queryBuilder({showPreviousValues:t.showPreviousValues,filters:t.filters.map(function(e){return s(t,e)}),operators:i,lang:{operators:{changed_after:"changed on or after"}}})}function u(){window.FontDetect&&(FontDetect.isFontLoaded("14px/1 FontAwesome")||($(".use-icon-font").hide(),$(".use-icon-png").show()))}var p=function(e){var t,n,a,i,o=function(e){var t=$("#calendar",e);if(!t.length)return!1;var n={events_source:"/".concat(t.attr("data-event-source"),"/data_calendar/").concat((new Date).getTime()),view:t.data("view"),tmpl_path:"/tmpls/",tmpl_cache:!1,onAfterEventsLoad:function(e){var n;e&&((n=$("#eventlist")).html(""),$.each(e,function(e,t){$(document.createElement("li")).html('<a href="'.concat(t.url,'">').concat(t.title,"</a>")).appendTo(n)}))},onAfterViewLoad:function(e){$("#caltitle").text(this.getTitle()),$(".btn-group button").removeClass("active"),$('button[data-calendar-view="'.concat(e,'"]')).addClass("active")},classes:{months:{general:"label"}}},a=t.data("calendar-day-ymd");return a&&(n.day=a),t.calendar(n)}(e);o&&(a=o,i=e,$(".btn-group button[data-calendar-nav]",i).each(function(){var e=$(this);e.click(function(){a.navigate(e.data("calendar-nav"))})}),$(".btn-group button[data-calendar-view]",i).each(function(){var e=$(this);e.click(function(){a.view(e.data("calendar-view"))})}),t=o,n=e,$("#first_day",n).change(function(){var e=(e=$(this).val()).length?parseInt(e):null;t.setOptions({first_day:e}),t.view()}),$("#language",n).change(function(){t.setLanguage($(this).val()),t.view()}),$("#events-in-modal",n).change(function(){var e=$(this).is(":checked")?$(this).val():null;t.setOptions({modal:e})}),$("#events-modal .modal-header, #events-modal .modal-footer",n).click(function(){}),u())},f=function(e){h(e)};function m(t){return t=t||{},_.chain(location.search.slice(1).split("&")).map(function(e){if(e)return e.split("=")}).compact().value().filter(function(e){return e[0]!==t.except})}function h(e){$(".column-filter",e).each(function(){function a(){return s.length?s.val():""}function t(){var t=a();p.empty();var e=_.filter(l,function(e){return-1<e.value.toLowerCase().indexOf(t.toLowerCase())}),n=1===s.length?_.sortBy(e,"value"):e;_.each(n,function(e,t){var n,a;p.append((n=e,a="column_filter_value_label_"+i+"_"+t,$('<li class="column-filter__value"><label id="'+a+'_label" for="'+a+'"><input id="'+a+'" type="checkbox" value="'+n.id+'" '+(n.checked?"checked":"")+' aria-labelledby="'+a+'_label"><span role="option">'+n.value+"</span></label></li>")))})}function n(){c.attr("hidden",""),t()}var e=$(this),i=e.data("col-id"),o=e.data("autocomplete-endpoint"),r=e.data("autocomplete-has-id"),l=e.data("values")||[],c=e.find(".column-filter__error"),s=e.find(".column-filter__search-input"),d=e.find(".column-filter__clear-search-input"),u=e.find(".column-filter__spinner"),p=e.find(".column-filter__values"),f=e.find(".column-filter__submit"),h=_.debounce(function(){var e=a();e.length?(c.attr("hidden",""),u.removeAttr("hidden"),$.getJSON(o+e,function(e){_.each(e,function(t){r?_.some(l,function(e){return e.id===t.id.toString()})||l.push({id:t.id.toString(),value:t.name}):l.push({value:t})})}).fail(function(e,t,n){c.text(n),c.removeAttr("hidden")}).always(function(){u.attr("hidden",""),t()})):n()},250);p.delegate("input","change",function(){var t=$(this).val(),e=_.findIndex(l,function(e){return e.id===t});l[e].checked=this.checked}),s.on("keyup",function(){$(this).val().length?d.removeAttr("hidden"):d.attr("hidden","")});function v(e){return void 0===e[1]?e[0]:e[0]+"="+e[1]}r?(s.on("keyup",h),f.on("click",function(){var e=_.map(_.filter(l,"checked"),"id"),t=m({except:"field"+i});e.forEach(function(e){t.push(["field"+i,e])}),window.location="?"+t.map(v).join("&")})):(s.on("keypress",function(e){13===e.keyCode&&(e.preventDefault(),f.trigger("click"))}),f.on("click",function(){var e=m({except:"field"+i});e.push(["field"+i,a()]),window.location="?"+e.map(v).join("&")})),d.on("click",function(e){e.preventDefault(),s.val(""),d.attr("hidden",""),n()}),t()})}function v(e,t,n,a){t.attr("aria-expanded",n),t.toggleClass("expanded--permanent",n&&a);var i=t.data("label-expanded"),o=t.data("label-collapsed");o&&i&&t.html(n?i:o);var r,l,c,s,d,u=t.siblings(".expandable").first();u.toggleClass("expanded",n),u.hasClass("popover")&&(l=(r=t.offset()).top,c=r.left,(s=t.offsetParent())&&(l-=(d=s.offset()).top,c-=d.left),function(e,t,n){var a,i=t+"px",o=e+n+"px";this.css({left:i,top:o}),document.body&&document.body.clientWidth&&this.get(0).getBoundingClientRect&&((a=document.body.clientWidth-this.get(0).getBoundingClientRect().right)<0&&this.css({left:t+a+"px"}))}.call(u,l,c,t.outerHeight()+6)),t.trigger(n?"expand":"collapse",u),e.stopPropagation()}function g(e){var t=$(this),n=t.hasClass("expanded--permanent");v(e,t,!n,!0)}function b(e){var t=$(this);"true"===t.attr("aria-expanded")||v(e,t,!0,!1)}function y(e){var t=$(this),n="true"===t.attr("aria-expanded"),a=t.hasClass("expanded--permanent");n&&!a&&v(e,t,!1,!1)}function w(e){$(".trigger[aria-expanded]",e).on("click",g),$(".trigger[aria-expanded]",e).on("mouseover",b),$(".trigger[aria-expanded]",e).on("mouseout",y)}var O=function(e){$(".select-widget",e).each(function(){var e=$(this).hasClass("multi");k.call($(this),e)})};function k(e){function o(e,t,n){v.removeClass("select-widget--open"),t.attr("aria-expanded",!1),setTimeout(function(){k.val(""),n.attr("hidden",""),w.removeAttr("hidden")},50)}function d(){var e=m.children("[data-list-item]:not([hidden])");m.toggleClass("empty",0===e.length),r.trigger("change")}function u(e){var t=e.relatedTarget||document.activeElement;v.find(t).length||!t||$(t).is(".modal, .page")||v.get(0).parentNode===t||o(0,l,c)}function p(){var n;e?_.each((n=d,function(){var t=$(this),e=t.data("list-item"),o=$("#"+e);o.unbind("change"),o.on("change",function(e){e.stopPropagation(),$(this).prop("checked")?t.removeAttr("hidden"):t.attr("hidden",""),n()}),o.unbind("keydown"),o.on("keydown",function(e){var t=e.which||e.keyCode;switch(t){case 38:case 40:var n,a=g.find(".answer:not([hidden])"),i=a.index(o.closest(".answer"));e.preventDefault(),(n=38===t?a[i-1]:a[i+1])&&$(n).find("input").focus();break;case 13:e.preventDefault(),$(this).trigger("click")}})})):_.each(function(e,t){var n=$(t),a=n.data("list-item"),i=$("#"+a);i.unbind("click"),i.on("click",function(e){e.stopPropagation()}),i.parent().unbind("keypress"),i.parent().on("keypress",function(e){13!==e.keyCode&&32!==e.keyCode||(e.preventDefault(),$(this).trigger("click"))}),i.parent().unbind("click"),i.parent().on("click",function(e){e.stopPropagation(),_.each(function(){$(this).attr("hidden","")}),m.toggleClass("empty",!1),n.removeAttr("hidden"),r.trigger("change"),o(0,l,c)})})}function f(e,t,n,a,i){return e&&!n?$('<li class="none-selected">blank</li>'):$("<li "+(i?"":"hidden")+' data-list-item="'+(n?t+"_"+n:t+"__blank")+'" data-list-text="'+a+'" class="'+(n?"":"current__blank")+'"><span class="widget-value__value">'+a+"</span>"+(e?'<button class="close select-widget-value__delete" aria-hidden="true" aria-label="delete" title="delete" tabindex="-1">&times;</button>':"")+"</li>")}function h(e,t,n,a,i){if(e&&!n)return null;var o=n?t+"_"+n:t+"__blank";return $('<li class="'+(n?"answer":"answer answer--blank")+'"><span class="control"><label id="'+o+'_label" for="'+o+'"><input id="'+o+'" type="'+(e?"checkbox":"radio")+'" name="'+t+'" '+(i?"checked":"")+' value="'+(n||"")+'" class="'+(e?"":"visually-hidden")+'" aria-labelledby="'+o+'_label"><span role="option">'+a+"</span></label></span>"+(n?'<span class="details"><button type="button" class="more-info" data-record-id="'+n+'" aria-describedby="'+o+'_label" aria-haspopup="listbox">Details</button></span>':"")+"</li>")}function t(e,t,n){var a,i,o,r,l;"true"!==t.attr("aria-expanded")&&(v.addClass("select-widget--open"),t.attr("aria-expanded",!0),v.data("filter-endpoint")&&v.data("filter-endpoint").length&&function(){var i=v.data("field"),o=v.hasClass("multi"),r=v.data("filter-endpoint"),e=v.data("filter-fields"),t=v.data("submission-token");$.isArray(e)||Linkspace.error("Invalid data-filter-fields found. It should be a proper JSON array of fields.");var l=g.find("input:checked").map(function(){return parseInt($(this).val())}).get(),c=["submission-token="+t];$.each(e,function(e,a){$("input[name="+a+"]").each(function(e,t){var n=$(t);switch(n.attr("type")){case"text":c.push(a+"="+n.val());break;case"radio":case"checkbox":t.checked&&c.push(a+"="+n.val());break;case"hidden":c.push(a+"="+n.val())}})});var s=c.join("&");x!==s&&(x=null,g.find(".answer").remove(),g.find(".spinner").removeAttr("hidden"),$.getJSON(r+"?"+s,function(e){var t,n,a;_.remove(),0===e.error?(t=l.includes(NaN),k.parent().prev(".none-selected").remove(),k.parent().before(f(o,i,null,"blank",t)),g.append(h(o,i,null,"blank",t)),$.each(e.records,function(e,t){var n=l.includes(t.id);k.parent().before(f(o,i,t.id,t.label,n)),g.append(h(o,i,t.id,t.label,n))}),_=m.find("[data-list-item]"),g=v.find(".available"),b=v.find(".available .answer input"),y=v.find(".available .answer .more-info"),w=v.find(".answer"),d(),p(),b.on("blur",u),y.on("blur",u),x=s):(n=1===e.error?e.message:"Oops! Something went wrong.",a=$('<li class="answer answer--blank alert alert-danger"><span class="control"><label>'+n+"</label></span></li>"),g.append(a))}).fail(function(e,t,n){Linkspace.error("Failed to make request to "+r+": "+t+": "+n);var a=$('<li class="answer answer--blank alert alert-danger"><span class="control"><label>Oops! Something went wrong.</label></span></li>');g.append(a)}).always(function(){g.find(".spinner").attr("hidden","")}))}(),i=(a=e.offset().top)+e.outerHeight(),r=(o=$(window).scrollTop())+$(window).height()-60,l=o<a-200&&!(i+200<r),n.toggleClass("available--top",l),n.removeAttr("hidden"),k.get(0)!==document.activeElement&&k.focus())}var v=this,r=this.find(".form-control"),l=r.find("[aria-expanded]"),m=this.find(".current"),g=this.find(".available"),b=this.find(".available .answer input"),y=this.find(".available .answer .more-info"),c=this.find("#"+l.attr("aria-controls")),_=m.find("[data-list-item]"),w=this.find(".answer"),n=null,k=this.find(".form-control-search"),x=null;function a(e){e.stopPropagation(),t(r,l,c)}d(),p(),r.unbind("click"),r.on("click",function(){"true"===l.attr("aria-expanded")?o(0,l,c):t(r,l,c)}),k.unbind("blur"),k.on("blur",u),b.unbind("blur"),b.on("blur",u),y.unbind("blur"),y.on("blur",u),$(document).on("click",function(e){var t=!this.is(e.target)&&0===this.has(e.target).length,n=0!==$(e.target).closest(".modal").length;t&&!n&&o(0,l,c)}.bind(this)),$(document).keyup(function(e){27==e.keyCode&&o(0,l,c)}),r.delegate(".select-widget-value__delete","click",function(e){e.preventDefault(),e.stopPropagation();var t=e.target.parentElement.getAttribute("data-list-item"),n=document.querySelector("#"+t);n.checked=!1,$(n).trigger("change")}),k.unbind("focus",a),k.on("focus",a),k.unbind("keydown"),k.on("keydown",function(e){var t=e.which||e.keyCode;switch(t){case 38:case 40:var n,a=g.find(".answer:not([hidden]) input");e.preventDefault(),(n=38===t?a[a.length-1]:a[0])&&$(n).focus();break;case 13:e.preventDefault();var i=g.find(".answer:not([hidden]) input").get(0);i&&$(i).parent().trigger("click")}}),k.unbind("keyup"),k.on("keyup",function(){var e=$(this).val().toLowerCase();(n=n||$("<span>").addClass("form-control-search").css("white-space","nowrap")).text(e),k.css("width",n.insertAfter(k).width()+70),n.detach();var t=!1;$.each(w,function(){-1===$(this).find("label")[0].innerHTML.toLowerCase().indexOf(e)?$(this).attr("hidden",""):(t=!0,$(this).removeAttr("hidden",""))}),t?g.find(".has-noresults").attr("hidden",""):g.find(".has-noresults").removeAttr("hidden","")}),k.unbind("click"),k.on("click",function(e){e.stopPropagation()})}function A(e,t){if(0==e.length||"none"==e.css("display"))return[""];var n=e.data("column-type"),a=[];return"enum"===n||"curval"===n?t?e.find(".select-widget .available .answer").each(function(){var e=$(this).find('[role="option"]');a.push(e.text())}):e.find(".select-widget .current [data-list-item]:not([hidden])").each(function(){var e=$(this).hasClass("current__blank")?"":$(this).data("list-text");a.push(e)}):"person"===n?a=[e.find("option:selected").text()]:"tree"===n?e.find(".selected-tree-value").each(function(){a.push($(this).data("text-value"))}):a="daterange"===n?e.find(".form-control").map(function(){return $(this).val()}).get().join(" to "):[e.find(".form-control").val()],0==a.length&&(a=[""]),a}function D(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var x=function(e){var d,t;d=e,$(document,d).on("mousedown",".curval-modal",function(e){var t,n=$(e.target).data("layout-id"),a=$(e.target).data("instance-name"),i=$(e.target).data("current-id"),o=$(e.target).closest(".curval_item").find("input[name=field".concat(n,"]")),r=o.val(),l=o.length?"edit":"add";"edit"==l&&((t=o.data("guid"))||(t=D(),o.attr("data-guid",t)));var c=$("#curval_modal",d);c.find(".modal-body").text("Loading...");var s=i?"/record/".concat(i):"/".concat(a,"/record/");c.find(".modal-body").load("".concat(s,"?include_draft&modal=").concat(n,"&").concat(r),function(){"edit"==l&&c.find("form").data("guid",t),Linkspace.init(c)}),c.on("focus",".datepicker",function(){$(this).datepicker({format:c.attr("data-dateformat-datepicker"),autoclose:!0})}),c.modal()}),T(e),t=e,$(".curval_group",t).on("click",".curval_remove",function(){$(this).closest(".curval_item").remove()}),$(".select-widget",t).on("click",".curval_remove",function(){var e=$(this).closest(".answer").find("input").prop("id");$(this).closest(".select-widget").find(".current li[data-list-item=".concat(e,"]")).remove(),$(this).closest(".answer").remove()})};function L(e,t){e.find(".alert").text(t).removeAttr("hidden"),e.parents(".modal-content").get(0).scrollIntoView(),e.find("button[type=submit]").prop("disabled",!1)}function T(e){$("#curval_modal",e).on("submit",".curval-edit-form",function(e){e.preventDefault();var C=$(this),t=C.serialize();C.addClass("edit-form--validating"),C.find(".alert").attr("hidden",""),$.post(C.attr("action")+"?validate&include_draft",t,function(e){var t,a,i,o,r,n,l,c,s,d,u,p,f,h,v,m,g,b,y,_,w,k,x,T,j;0===e.error?(a=C,i=e.values,b=a.serialize(),y=a.data("modal-field-ids"),_=a.data("curval-id"),w=a.data("instance-name"),k=a.data("guid"),x=$("<input>",o).attr({type:"hidden",name:"field"+_,value:b}),T=$("div[data-column-id="+_+"]",o),"noshow"===(j=T.data("value-selector"))?(r=$('<tr class="curval_item">',o),jQuery.map(y,function(e){var t=a.find('[data-column-id="'+e+'"]'),n=A(t),n=i["field"+e];n=$("<div />",o).text(n).html(),r.append($('<td class="curval-inner-text">',o).append(n))}),n=$('<td>\n        <a class="curval-modal" style="cursor:pointer" data-layout-id="'.concat(_," data-instance-name=").concat(w,'>edit</a> | <a class="curval_remove" style="cursor:pointer">remove</a>\n      </td>'),o),r.append(n.append(x)),k?$('input[data-guid="'+k+'"]',o).val(b).closest(".curval_item").replaceWith(r):$("#curval_list_".concat(_),o).find("tbody").prepend(r)):"dropdown"===j?(l=T.find(".select-widget").first().hasClass("multi"),c=T.find(".current [data-list-item]"),s=T.find(".current .search"),d=T.find(".available"),l||(c.attr("hidden",""),d.find("li input").prop("checked",!1)),u=jQuery.map(y,function(e){var t=i["field"+e];return $("<div />").text(t).html()}).join(", "),k=D(),p="field".concat(_,"_").concat(k),f=l?'<button class="close select-widget-value__delete" aria-hidden="true" aria-label="delete" title="delete" tabindex="-1">&times;</button>':"",s.before('<li data-list-item="'.concat(p,'">').concat(u).concat(f,"</li>")),h=l?"checkbox":"radio",d.append('<li class="answer">\n        <span class="control">\n            <label id="'.concat(p,'_label" for="').concat(p,'">\n                <input id="').concat(p,'" name="field').concat(_,'" type="').concat(h,'" value="').concat(b,'" class="').concat(l?"":"visually-hidden",'" checked aria-labelledby="').concat(p,'_label">\n                <span>').concat(u,'</span>\n            </label>\n        </span>\n        <span class="details">\n            <a class="curval_remove" style="cursor:pointer">remove</a>\n        </span>\n      </li>')),O(T)):"typeahead"===j&&(v=T.find("input[name=field".concat(_,"]")),m=T.find("input[name=field".concat(_,"_typeahead]")),g=jQuery.map(y,function(e){var t=i["field"+e];return $("<div />").text(t).html()}).join(", "),v.val(b),m.val(g)),$(".modal.in",o).modal("hide")):(t=1===e.error?e.message:"Oops! Something went wrong.",L(C,t))},"json").fail(function(e,t,n){var a="Oops! Something went wrong: ".concat(t,": ").concat(n);L(C,a)}).always(function(){C.removeClass("edit-form--validating")})})}var j=function(e){$(".datepicker",e).datepicker({format:$(document.body).data("config-dataformat-datepicker"),autoclose:!0}),$(".input-daterange input.from",e).each(function(){$(this).on("changeDate",function(){var e=$(this).parents(".input-daterange").find(".datepicker.to");e.val()||e.datepicker("update",$(this).datepicker("getDate"))})}),$(document,e).on("click",".remove_datepicker",function(){var e=".datepicker"+$(this).data("field");$(e).datepicker("destroy"),alert("Date selector has been disabled for this field")})},C=function(e){var t,a,i;t=e,$(document,t).on("click",".cloneme",function(){var e=$(this).parents(".input_holder"),t=e.clone();t.removeAttr("id").insertAfter(e),t.find(":text").val(""),t.find(".datepicker").datepicker({format:e.attr("data-dateformat-datepicker"),autoclose:!0})}),$(document,t).on("click",".removeme",function(){var e=$(this).parents(".input_holder");0<e.siblings(".input_holder").length&&e.remove()}),a=e,$("#helptext_modal",a).on("show.bs.modal",function(e){var t=$(e.relatedTarget).data("load-url");$(this).find(".modal-body").load(t)}),$(document,a).on("click",".more-info",function(t){var e=$(t.target).data("record-id"),n=$("#readmore_modal",a);n.find(".modal-body").text("Loading..."),n.find(".modal-body").load("/record_body/"+e),n.one("show.bs.modal",function(e){e.isDefaultPrevented()||n.one("hidden.bs.modal",function(){$(t.target,a).is(":visible")&&$(t.target,a).trigger("focus")})}),n.one("keyup",function(e){27==e.keyCode&&e.stopPropagation()}),n.modal()}),x(e),j(e),i=e,$('input[type="text"][id^="typeahead_"]',i).each(function(e,n){$(n,i).change(function(){$(this).val()||$("#".concat(n.id,"_value"),i).val("")}),$(n,i).typeahead({delay:500,matcher:function(){return!0},sorter:function(e){return e},afterSelect:function(e){$("#".concat(n.id,"_value"),i).val(e.id)},source:function(e,t){return $.ajax({type:"GET",url:"/".concat($(n,i).data("layout-id"),"/match/layout/").concat($(n).data("typeahead-id")),data:{q:e},success:function(e){t(e)},dataType:"json"})}})})},S=function(e){$(".fileupload",e).each(function(){var o=$(this),r=o.find("ul"),e=o.data("fileupload-url"),l=o.data("field"),t=o.find(".progress-bar__container"),a=o.find(".progress-bar__progress"),i=o.find(".progress-bar__percentage");o.fileupload({dataType:"json",url:e,paramName:"file",submit:function(){t.css("display","block"),i.html("0%"),a.css("width","0%")},progress:function(e,t){var n;o.data("multivalue")||(n=Math.round(t.loaded/t.total*1e4)/100+"%",i.html(n),a.css("width",n))},progressall:function(e,t){var n;o.data("multivalue")&&(n=Math.round(t.loaded/t.total*1e4)/100+"%",i.html(n),a.css("width",n))},done:function(e,t){o.data("multivalue")||r.empty();var n=t.result.url.split("/").pop(),a=t.files[0].name,i=$('<li class="help-block"><input type="checkbox" name="'+l+'" value="'+n+'" aria-label="'+a+'" checked>Include file. Current file name: <a href="/file/'+n+'">'+a+"</a>.</li>");r.append(i)}})})},q=function(e){$(".edit-form *:input[type!=hidden]:first",e).focus()},R=function(e){var t,n,a;(a=$("#globe",e)).length&&(Plotly.setPlotConfig({locale:"en-GB"}),t=JSON.parse(base64.decode(a.attr("data-globe"))),n={showLink:!1,displaylogo:!1,modeBarButtonsToRemove:["sendDataToCloud"],topojsonURL:"".concat(a.attr("data-url"),"/")},Plotly.newPlot("globe",t,{margin:{t:10,l:10,r:10,b:10},geo:{scope:"world",showcountries:!0,countrycolor:"grey",resolution:110}},n))},E=function(e){!function(e){Plotly.setPlotConfig({locale:"en-GB"});var o=JSON.parse(base64.decode(e.data("globe-data"))),t=o.data,n={showLink:!1,displaylogo:!1,modeBarButtonsToRemove:["sendDataToCloud"],topojsonURL:e.data("topojsonurl")};Plotly.newPlot(e.get(0),t,{margin:{t:10,l:10,r:10,b:10},geo:{scope:"world",showcountries:!0,countrycolor:"grey",resolution:110}},n).then(function(e){e.on("plotly_click",function(e){var t,n,a,i;e.event.defaultPrevented||(t=(e.points||[])[0],a=(n=o.params).globe_fields.map(function(e){return e+"="+t.location}).join("&"),i="/"+n.layout_identifier+"/data?viewtype=table&view="+n.view_id+"&"+a,n.default_view_limit_extra_id&&(i=i+"&extra="+n.default_view_limit_extra_id),location.href=i)})})}(e)},P=function(e){N(e)};function N(e){$.summernote&&$(".summernote",e).summernote({dialogsInBody:!0,height:400,callbacks:{onInit:function(){var e=$(this).siblings("input[type=hidden].summernote_content");$(this).summernote("code",e.val())},onImageUpload:function(e){for(var t=0;t<e.length;t++)!function(e,t){var n;e.type.includes("image")?((n=new FormData).append("file",e),n.append("csrf_token",$("body").data("csrf-token")),$.ajax({url:"/file?ajax&is_independent",type:"POST",contentType:!1,cache:!1,processData:!1,dataType:"JSON",data:n,success:function(e){e.is_ok?$(t).summernote("editor.insertImage",e.url):Linkspace.debug(e.error)}}).fail(function(e){Linkspace.debug(e)})):Linkspace.debug("The type of file uploaded was not an image")}(e[t],this)},onChange:function(e){var t=$(this).closest(".summernote");t.summernote("isEmpty")&&(e=""),t.siblings("input[type=hidden].summernote_content").val(e)}}})}var I=function(e){var t,n,a,i,o,r,l,c,s,d,u,p;!function(n){$("#btnDeleteNode",n).click(function(){var e=$("#jstree_demo_div",n).jstree(!0),t=e.get_selected();if(!t.length)return!1;e.delete_node(t)}),$("#btnAddNode",n).click(function(){var e=$("#jstree_demo_div",n).jstree(!0),t=(t=e.get_selected()).length?t[0]:"#";(t=e.create_node(t,{type:"file"}))&&e.edit(t)}),$("#btnRenameNode",n).click(function(){var e=$("#jstree_demo_div",n).jstree(!0),t=e.get_selected();if(!t.length)return!1;t=t[0],e.edit(t)})}(e),t=e,$("#selectall",t).click(function(){7==$(".check_perm:checked",t).length?$(".check_perm",t).prop("checked",!1):$(".check_perm",t).prop("checked",!0)}),n=e,$(".sortable",n).length&&$(".sortable",n).sortable({handle:".drag"}),(a=$("#jstree_demo_div",e)).length&&a.jstree({core:{check_callback:!0,force_text:!0,themes:{stripes:!0},data:{url:function(){return"/".concat(a.data("layout-identifier"),"/tree").concat((new Date).getTime(),"/").concat(a.data("column-id"),"?")},data:function(e){return{id:e.id}}}}}),i=e,$("div#legs",i).on("click",".add",function(e){$(e.currentTarget,i).closest("#legs").find(".sortable").append('\n          <div class="request-row">\n            <p>\n              <input type="hidden" name="enumval_id">\n              <input type="text" class="form-control" style="width:80%; display:inline" name="enumval">\n              <button type="button" class="close closeme" style="float:none">&times;</button>\n              <span class="fa fa-hand-paper-o fa-lg use-icon-font close drag" style="float:none"></span>\n            </p>\n          </div>\n      '),$(".sortable",i).sortable("refresh")}),$("div#legs").on("click",".closeme",function(e){$(".request-row",i).length<2||$(e.currentTarget,i).parents(".request-row").remove()}),o=e,$("#refers_to_instance_id",o).change(function(e){var t="#instance_fields_".concat($(e.currentTarget,o).val());$(".instance_fields",o).hide(),$(t,o).show()}),r=e,$("#related_field_id",r).change(function(e){var t=$(e.currentTarget).find(":selected").data("instance_id");$(".autocur_instance",r).hide(),$("#autocur_instance_".concat(t),r).show()}),$("#filval_related_field_id",r).change(function(){var e=$(this).val();$(".filval_curval",r).hide(),$("#filval_curval_"+e,r).show()}),$('div[id^="builder"]',e).each(function(e,t){var n,a=$(t).data("filter-base");a&&(n=base64.decode(a),$(t).queryBuilder("setRules",JSON.parse(n)))}),(s=$("#displayConditionsBuilder",e)).length&&(l=s.data(),s.queryBuilder({filters:l.filters,allow_groups:0,operators:[{type:"equal",accept_values:!0,apply_to:["string"]},{type:"contains",accept_values:!0,apply_to:["string"]},{type:"not_equal",accept_values:!0,apply_to:["string"]},{type:"not_contains",accept_values:!0,apply_to:["string"]}]}),l.filterBase&&(c=base64.decode(l.filterBase),s.queryBuilder("setRules",JSON.parse(c)))),d=e,$("#submit_save",d).click(function(){var e=$("#displayConditionsBuilder",d).queryBuilder("getRules");$("#displayConditions",d).val(JSON.stringify(e,null,2));var t="#builder".concat($("#refers_to_instance_id",d).val()),n=$("#jstree_demo_div",d);if(n.length&&n.is(":visible")){var a=n.jstree(!0).get_json("#",{flat:!1}),i=JSON.stringify(a),o=n.data();return $.ajax({async:!1,type:"POST",url:"/".concat(o.layoutIdentifier,"/tree/").concat(o.columnId),data:{data:i,csrf_token:o.csrfToken}}).done(function(){alert("Tree has been updated")}),!0}return $(t,d).is(":visible")&&UpdateFilter($(t,d)),!0}),u=e,$("#type",u).on("change",function(){var e=$("#manage-fields",u),t=e.data("column-type"),n=$(this).val();e.removeClass("column-type-"+t),e.addClass("column-type-"+n),e.data("column-type",n),"rag"==n||"intgr"==n||"person"==n?$("#checkbox-multivalue",u).hide():$("#checkbox-multivalue",u).show()}).trigger("change"),p=e,$("#notify_on_selection",p).on("change",function(){$(this).prop("checked")?$("#notify-options",p).show():$("#notify-options",p).hide()}).trigger("change")},F=function(e){$(".more-less",e).each(function e(){var l,t,n,c=$(this),a=c.data("column"),i=c.html();c.removeClass("transparent"),B(c)<100||(c.addClass("clipped"),l=$("<div/>",{class:"expandable popover column-content",html:i}),t="Show "+a+" &rarr;",(n=$("<button/>",{class:"btn btn-xs btn-primary trigger",html:t,type:"button","aria-expanded":!1,"data-label-expanded":"Hide "+a,"data-label-collapsed":t})).on("toggle",function(e,t){var n=$(window).width(),a=l.offset().left,i=c.width(),o=400<i?i:400;if("expanded"===t){if(l.css("width",o+"px"),a+o+20<n)return;var r=n-(a+o+20);l.css("left",a+r+"px")}}),c.empty().append(n).append(l),w(c),l.find(".more-less").each(e))})};function B(e){if(e.attr("data-actual-height"))return e.attr("data-actual-height");if(e.height())return e.height();var a=function e(t){if("none"==t.css("display"))return t;var n=t.parent();return n&&n.length?e(n):void 0}(e);if(a){a.find(".more-less").each(function(){$(this).addClass("more-less-id-"+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))});var t=a.clone().attr("id",!1).css({visibility:"hidden",display:"block",position:"absolute"});return $("body").append(t),t.find(".more-less").each(function(){var n=$(this),e=n.attr("class").split(/\s+/);$.each(e,function(e,t){0<=t.indexOf("more-less-id")&&a.find("."+t).attr("data-actual-height",n.height())})}),t.remove(),e.attr("data-actual-height")}}var J=function(e){M("#modalregister",e),M("#modal-reset-password",e)};function M(e,t){var n=$(e,t);n.data("open-on-load")&&n.modal("show")}function e(){P()}function H(){W()}function z(){$(".globe").each(function(){E($(this))}),W()}var G=function(e){var r,t;r=e,(t=$("#modal_metric",r)).length&&t.on("show.bs.modal",function(e){var t=$(e.relatedTarget),n=t.data("metric_id");$("#metric_id",r).val(n),n?$("#delete_metric",r).show():$("#delete_metric",r).hide();var a=t.data("target_value");$("#target_value",r).val(a);var i=t.data("x_axis_value");$("#x_axis_value",r).val(i);var o=t.data("y_axis_grouping_value");$("#y_axis_grouping_value",r).val(o)})},U=function(e){var t;(t=$("#mygraphs-table",e)).length&&t.dataTable({columnDefs:[{targets:0,orderable:!1}],pageLength:50,order:[[1,"asc"]]})},W=function(e){var n;n=$("body").data("layout-identifier"),$("#views_other_user_typeahead").typeahead({delay:500,matcher:function(){return!0},sorter:function(e){return e},afterSelect:function(e){$("#views_other_user_id").val(e.id)},source:function(e,t){return $.ajax({type:"GET",url:"/"+n+"/match/user/",data:{q:e},success:function(e){t(e)},dataType:"json"})}})},V=function(a){$(document).ready(function(){var e,t,n;e=a,t=$("#chartdiv",e),n=$("[id^=chartdiv]",e),!t.length&&n.length&&Z(n)})};function Q(e,t){var n=e.xlabels,a={},i="line"==t.type;a.highlighter={showMarker:i,tooltipContentEditor:function(e,t,n,a){return a._plotData[t][n][1]}};var o={bar:{renderer:$.jqplot.BarRenderer,rendererOptions:{shadow:!1,fillToZero:!0,barMinWidth:10},pointLabels:{show:!1,hideZeros:!0}},donut:{renderer:$.jqplot.DonutRenderer,rendererOptions:{sliceMargin:3,showDataLabels:!0,dataLabels:"value",shadow:!1}},pie:{renderer:$.jqplot.PieRenderer,rendererOptions:{showDataLabels:!0,dataLabels:"value",shadow:!1}},default:{pointLabels:{show:!1}}};t.type in o?a.seriesDefaults=o[t.type]:a.seriesDefaults=o.default,"donut"!=t.type&&"pie"!=t.type&&(a.series=e.labels,a.axes={xaxis:{renderer:$.jqplot.CategoryAxisRenderer,ticks:n,label:t.x_axis_name,labelRenderer:$.jqplot.CanvasAxisLabelRenderer},yaxis:{label:t.y_axis_label,labelRenderer:$.jqplot.CanvasAxisLabelRenderer}},e.options.y_max&&(a.axes.yaxis.max=e.options.y_max),e.options.is_metric&&(a.axes.yaxis.tickOptions={formatString:"%d%"}),a.axesDefaults={tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:-30,fontSize:"8pt"}}),a.stackSeries=t.stackseries,a.legend={renderer:$.jqplot.EnhancedLegendRenderer,show:t.showlegend,location:"e",placement:"outside"},$.jqplot("chartdiv".concat(t.id),e.points,a)}function Z(e){u(),$.jqplot.config.enablePlugins=!0,e.each(function(e,t){var n,a,i=$(t).data(),o=(new Date).getTime(),r="/".concat(i.layoutId,"/data_graph/").concat(i.graphId,"/").concat(o),l=(n=r,a=null,$.ajax({async:!1,url:n,dataType:"json",success:function(e){a=e}}),a),c={type:i.graphType,x_axis_name:i.xAxisName,y_axis_label:i.yAxisLabel,stackseries:i.stackseries,showlegend:i.showlegend,id:i.graphId};Q(l,c)})}function K(e){W(),V(e)}function Y(){X(),W(),$("#modal_sendemail").on("show.bs.modal",function(e){var t=$(e.relatedTarget).data("peopcol_id");$("#modal_sendemail_peopcol_id").val(t)}),$("#data-table").floatThead({floatContainerCss:{},zIndex:function(){return 999},ariaLabel:function(e,t){return t.data("thlabel")}}),FontDetect.isFontLoaded("14px/1 FontAwesome")||($(".use-icon-font").hide(),$(".use-icon-png").show()),$("#rows_per_page").on("change",function(){this.form.submit()})}var X=function(e){$(".table tr[data-href]",e).on("click",function(){window.location=$(this).data("href")})},ee=function(e){var t,n;n=(t=e)||document,tippy(n.querySelectorAll(".vis-foreground"),{target:".timeline-tippy",theme:"light",onShown:function(){$(".moreinfo",t).off("click").on("click",function(e){var t=$(e.target).data("record-id"),n=$("#readmore_modal");n.find(".modal-body").text("Loading..."),n.find(".modal-body").load("/record_body/"+t),n.modal()})}})};function te(e){e.forEach(function(e){var t,n,a,i,o,r,l;!e.style||"string"!=typeof e.style||(t=e.style.match(/background-color:\s(#[0-9A-Fa-f]{6})/))&&t[1]&&(n=t[1],"dark"==(i=+("0x"+(a=n).slice(1).replace(a.length<5&&/./g,"$&$&")),o=i>>16,r=i>>8&255,l=255&i,150<Math.sqrt(o*o*.299+r*r*.587+l*l*.114)?"light":"dark")&&(e.style=e.style+"; color: #FFFFFF"))})}function ne(l,e){var t=l.data("records"),n=base64.decode(t),a=JSON.parse(n);te(a);var i,c=new vis.DataSet(a),o=l.data("groups"),r=base64.decode(o),o=JSON.parse(r),s=!!l.data("dashboard"),d=$("body").data("layout-identifier"),u={margin:{item:{horizontal:-1}},moment:(i=function(e){return moment(e).utc()},p.toString=function(){return i.toString()},p),clickToUse:s,zoomFriction:10,template:Handlebars.templates.timelineitem,orientation:{axis:"both"}};function p(e){return i.apply(this,arguments)}for(var f in e)u[f]=e[f];l.data("min")&&(u.start=l.data("min")),l.data("max")&&(u.end=l.data("max")),l.data("width")&&(u.width=l.data("width")),l.data("height")&&(u.width=l.data("height")),l.data("rewind")||(u.editable={add:!1,updateTime:!0,updateGroup:!1,remove:!1},u.multiselect=!0);var h,v,m=new vis.Timeline(l.get(0),c,u);0<o.length&&m.setGroups(o),m.on("rangechanged",function(e){return e.byUser?(e.start.getTime()>v&&e.end.getTime()<h||(l.prev("#loading-div").show(),t=c.min("start"),n=(t=c.max("start"))?new Date(t.start):void 0,(a=(t=c.min("end"))?new Date(t.end):void 0)&&!t.has_time&&a.setDate(a.getDate()-1),t=c.max("end"),i=(t=c.min("single"))?new Date(t.single):void 0,o=(t=c.max("single"))?new Date(t.single):void 0,(r={}).min=a&&i?a<i?a:i:a||i,r.max=n&&o?o<n?n:o:n||o,r.min||y(e.start.getTime(),e.end.getTime()),e.start<r.min&&y(e.start.getTime(),r.min.getTime(),"to"),e.end>r.max&&y(r.max.getTime(),e.end.getTime(),"from"),(!h||h<e.end.getTime())&&(h=e.end.getTime()),(!v||v>e.start.getTime())&&(v=e.start.getTime()),l.prev("#loading-div").hide()),void b(e)):(v=v||e.start.getTime(),void(h=h||e.end.getTime()));var t,n,a,i,o,r});var g=$("body").data("csrf-token");function b(e){s||$.post({url:"/"+d+"/data_timeline?",data:"from="+e.start.getTime()+"&to="+e.end.getTime()+"&csrf_token="+g})}function y(e,t,n){var a="/"+d+"/data_timeline/10?from="+e+"&to="+t+"&exclusive="+n;s&&(a=a+"&dashboard=1&view="+l.data("view")),$.ajax({async:!1,url:a,dataType:"json",success:function(e){c.add(e)}})}return m}function ae(){var i="#submit_button",o={},e={onMove:function(e,t){o[e.id]=e;var n=$(i);n.is(":hidden")&&($(window).bind("beforeunload",function(e){var t="If you leave this page your changes will be lost.";return e&&(e.returnValue=t),t}),n.closest("form").css("display","block"));var a=$("<li>"+e.content+"</li>");return $("#visualization_changes").append(a),t(e)},snap:function(e){var t=e.getUTCFullYear(),n=("0"+(e.getUTCMonth()+1)).slice(-2),a=("0"+e.getUTCDate()).slice(-2);return timeline.moment.utc(""+t+n+a)}},t=ne($(".visualization"),e);function n(e){var n,t,a=e.items;0==a.length?$(".bulk_href").on("click",function(e){return e.preventDefault(),alert("Please select some records on the timeline first"),!1}):(n=[],$("#delete_ids").empty(),e.items.forEach(function(e){var t=e.replace(/\+.*/,"");n.push("id="+t),$("#delete_ids").append('<input type="hidden" name="delete_id" value="'+t+'">')}),t=n.join("&"),$("#update_href").attr("href","/"+r+"/bulk/update/?"+t),$("#clone_href").attr("href","/"+r+"/bulk/clone/?"+t),$("#count_delete").text(a.length),$(".bulk_href").off())}$(i).bind("click",function(){var e=_.mapObject(o,function(e){return{column:e.column,current_id:e.current_id,from:e.start.getTime(),to:(e.end||e.start).getTime()}});$(window).off("beforeunload");var t=JSON.stringify(e);$("#changed_data").attr("value",t)}),$("#cancel_button").bind("click",function(){$(window).off("beforeunload")});var r=$("body").data("layout-identifier");t.on("select",n),n({items:[]}),ee(),W()}var ie=function(e){$('[data-column-type="tree"]',e).filter(function(){return $(this).find(".tree-widget-container").length}).each(oe)};function oe(){var e=$(this),t=e.data("column-id"),n=e.data("is-multivalue"),a=e.find(".tree-widget-container"),i=a.data("field"),o=$("body").data("layout-identifier"),r=a.data("end-node-only"),l=a.data("ids-as-params"),c={core:{check_callback:!0,force_text:!0,themes:{stripes:!0},data:{url:function(){return"/"+o+"/tree"+(new Date).getTime()+"/"+t+"?"+l},data:function(e){return{id:e.id}}}},plugins:[]};n?c.plugins.push("checkbox"):c.core.multiple=!1,a.on("changed.jstree",function(e,n){a.nextAll(".selected-tree-value").remove();var t=a.jstree("get_selected",!0);$.each(t,function(){var e=$('<input type="hidden" class="selected-tree-value" name="'+i+'" value="'+this.id+'" />').insertAfter(a),t=n.instance.get_path(this,"#");e.data("text-value",t)}),0==t.length&&a.after('<input type="hidden" class="selected-tree-value" name="'+i+'" value="" />'),a.trigger("change")}),a.on("select_node.jstree",function(e,t){0!=t.node.children.length&&(r?(a.jstree(!0).deselect_node(t.node),a.jstree(!0).toggle_node(t.node)):n&&a.jstree(!0).open_node(t.node))}),a.jstree(c),a.jstree(!0).settings.checkbox.cascade="undetermined"}var re=function(e){var r;r=e,$("[data-has-dependency]",r).map(function(){var e=$(this).data("dependency"),t=JSON.parse(base64.decode(e)),n=t.rules,a=t.condition,i=jQuery.map(n,function(e){var t=e.operator,n=-1!==t.indexOf("not"),a=-1!==t.indexOf("equal")?new RegExp("^"+e.value+"$","i"):new RegExp(e.value,"i"),i=e.id,o=!1;return e.filtered&&(i=e.filtered,o=!0),{dependsOn:$('[data-column-id="'+i+'"]',r),regexp:a,is_negative:n,filtered:o}});return{field:$(this),condition:a,rules:i}}).each(le)};function le(){var a=this.condition,i=this.rules,o=this.field;o.data("dependent-not-shown")&&o.hide(),i.forEach(function(e){function t(){!function(r,e){if(0==e.length)return!0;var l=!1;return e.some(function(e){var t=e.dependsOn,n=e.regexp,a=e.is_negative,i=A(t,e.filtered),o=!a;return $.each(i,function(e,t){a?n.test(t)&&(o=1):n.test(t)&&(o=0)}),o||(l=!0),!!r&&("OR"==r?l:(o&&(l=!1),!l))}),l}(a,i)?o.hide():o.show();var t=o.closest(".panel-group");t.length&&t.find(".linkspace-field").each(function(){var e=!0;if("none"!=$(this).css("display"))return t.show(),e=!1;e&&t.hide()}),o.trigger("change")}var n=e.dependsOn;0==n.length&&t(),n.on("change",function(){t()})})}var ce=function(e){$(".click-to-edit",e).on("click",function(){var e=$(this);this.innerHTML="Edit"===this.innerHTML?"View":"Edit",$(e.data("viewEl")).toggleClass("expanded"),$(e.data("editEl")).toggleClass("expanded"),"View"===this.innerHTML?window.onbeforeunload=se:window.onbeforeunload=null}),$(".submit_button").click(function(){window.onbeforeunload=null}),$(".remove-unload-handler").click(function(){window.onbeforeunload=null})};function se(e){var t="Please note that any changes will be lost.";return(e=e||window.event)&&(e.returnValue=t),t}function de(e){Linkspace.debug("Record edit JS firing"),ie(e),re(e),ce(e),me(e),function(e){var u=".intcalculator";$(".fileupload",e);$(u,e).closest(".form-group").find("label").each(function(){var i,c,e=$(this),s=$('<div class="dropdown-menu" id="calculator_div"></div>');s.css({position:"absolute","z-index":1100,display:"none",padding:"10px"}),$("body").append(s),s.append('<form class="form-inline">    <div class="form-group btn-group operator" data-toggle="buttons"></div>    <div class="form-group"><input type="text" placeholder="Number" class="form-control"></input></div>    <div class="form-group">        <input type="submit" value="Calculate" class="btn btn-default"></input>    </div></form>'),$(document).mouseup(function(e){s.is(e.target)||0!==s.has(e.target).length||s.hide()});var o=[{action:"add",subvaluelabel:"+",keypress:["+"],operation:function(e,t){return e+t}},{action:"subtract",label:"-",keypress:["-"],operation:function(e,t){return e-t}},{action:"multiply",label:"×",keypress:["*","X","x","×"],operation:function(e,t){return e*t}},{action:"divide",label:"÷",keypress:["/","÷"],operation:function(e,t){return e/t}}],r={},l=s.find(".operator");for(var d in o)!function(){var e=o[d],t=$('<label class="btn btn-primary" style="width:40px"><input type="radio" name="op" class="btn_label_'+e.action+'">'+e.label+"</input></label>");for(var n in l.append(t),t.on("click",function(){i=e.operation,s.find(":text").focus()}),e.keypress){var a=e.keypress[n];r[a]=e.action}}();s.find(":text").on("keypress",function(e){var t,n=e.key;n in r&&(t=".btn_label_"+r[n],s.find(t).click(),e.preventDefault())}),s.find("form").on("submit",function(e){var t=i(+c.val(),+s.find(":text").val());c.val(t),s.hide(),e.preventDefault()}),$('<span class="btn-xs btn-link openintcalculator">Calculator</span>').insertAfter(e).on("click",function(e){var t=$(e.target).closest(".form-group"),n=t.find(u),a=t.offset().top,i=t.height(),o=$("#calculator_div").height(),r=o<a?a-o:a+i;s.css({top:r,left:t.offset().left});var l=s.find(":text");l.val(""),s.show(),l.focus(),c=n})})}(e),ve(e)}function ue(){$("#is_shared").change(function(){$("#group_id_div").toggle(this.checked)}).change(),$(".date-grouping").change(function(){$("#trend").val()||$("#set_x_axis").find(":selected").data("is-date")?$("#x_axis_date_display").show():$("#x_axis_date_display").hide()}).change(),$("#trend").change(function(){$(this).val()?$("#group_by_div").hide():$("#group_by_div").show()}).change(),$("#x_axis_range").change(function(){"custom"==$(this).val()?$("#custom_range").show():$("#custom_range").hide()}).change(),$("#y_axis_stack").change(function(){"sum"==$(this).val()?$("#y_axis_div").show():$("#y_axis_div").hide()}).change()}function pe(e){ge(e),$("#submit").on("click",function(){$(".dtable").DataTable().column(0).nodes().to$().each(function(){var e=$(this).find("input");e.is(":checked")&&$('<input type="hidden" name="graphs">').val(e.val()).appendTo("form")})})}function fe(){var e=$(this),o=e.find('[role="tab"]'),r=e.find('[role="tabpanel"]'),l=[];function c(e){e&&e.preventDefault();var t=$(this);if("true"===t.attr("aria-selected"))return!1;var n=r.filter(t.attr("href")),a=o.filter('[aria-selected="true"]'),i=r.filter(".active");return a.attr("aria-selected",!1),i.removeClass("active"),t.attr("aria-selected",!0),n.addClass("active"),t.attr("tabindex","0"),o.filter('[aria-selected="false"]').attr("tabindex","-1"),!1}o.each(function(e){l[e]=$(this),$(this).data("index",e)}),o.on("click",c),o.on("keyup",function(e){var t,n=$(this).data("index"),a=e.keyCode,i=Linkspace.constants.ARROW_LEFT,o=Linkspace.constants.ARROW_RIGHT;[i,o].indexOf(a)<0||(a===i&&(t=l[n-1])||a===o&&(t=l[n+1]))&&(c.call(t),t.focus())}),o.filter('[aria-selected="false"]').attr("tabindex","-1")}var he,ve=function(e){$(".table--zebra",e).each(function(e,t){var n=!0;$(t).children("tbody").children("tr:visible").each(function(e,t){$(t).toggleClass("odd",n),$(t).toggleClass("even",!n),n=!n})})},me=function(e){var t;t=e,$(".click-to-view-blank",t).on("click",function(){var e="Show blank values"===this.innerHTML;$(".click-to-view-blank-field",t).toggle(e),this.innerHTML=e?"Hide blank values":"Show blank values",ve(t)})},ge=function(e){$(".dtable",e).each(function(){var e=$(this).data("page-length")||10;$(this).dataTable({order:[[1,"asc"]],pageLength:e})})},$e=window.do_plot_json=function(e,t){var n,a,i,o,r;e=JSON.parse(e),t=JSON.parse(t),a=t,i=(n=e).xlabels,o={},r="line"==a.type,o.highlighter={showMarker:r,tooltipContentEditor:function(e,t,n,a){return a._plotData[t][n][1]}},"bar"==a.type?o.seriesDefaults={renderer:$.jqplot.BarRenderer,rendererOptions:{shadow:!1,fillToZero:!0,barMinWidth:10},pointLabels:{show:!1,hideZeros:!0}}:"donut"==a.type?o.seriesDefaults={renderer:$.jqplot.DonutRenderer,rendererOptions:{sliceMargin:3,showDataLabels:!0,dataLabels:"value",shadow:!1}}:"pie"==a.type?o.seriesDefaults={renderer:$.jqplot.PieRenderer,rendererOptions:{showDataLabels:!0,dataLabels:"value",shadow:!1}}:o.seriesDefaults={pointLabels:{show:!1}},"donut"!=a.type&&"pie"!=a.type&&(o.series=n.labels,o.axes={xaxis:{renderer:$.jqplot.CategoryAxisRenderer,ticks:i,label:a.x_axis_name,labelRenderer:$.jqplot.CanvasAxisLabelRenderer},yaxis:{label:a.y_axis_label,labelRenderer:$.jqplot.CanvasAxisLabelRenderer}},n.options.y_max&&(o.axes.yaxis.max=n.options.y_max),n.options.is_metric&&(o.axes.yaxis.tickOptions={formatString:"%d%"}),o.axesDefaults={tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:-30,fontSize:"8pt"}}),o.stackSeries=a.stackseries,o.legend={renderer:$.jqplot.EnhancedLegendRenderer,show:a.showlegend,location:"e",placement:"outside"},$.jqplot("chartdiv"+a.id,n.points,o)},be=(he={config:e,data_calendar:H,data_globe:z,data_graph:K,data_table:Y,data_timeline:ae,edit:de,graph:ue,graphs:pe,index:function(e){$(document).ready(function(){$(".dashboard-graph",e).each(function(){var e=$(this),t=base64.decode(e.data("plot-data")),n=base64.decode(e.data("plot-options"));$e(t,n)}),$(".visualization",e).each(function(){ne($(this),{})}),$(".globe",e).each(function(){E($(this))}),ee(e)})},layout:function(e){$(".tab-interface").each(fe);function i(){r.find("input").each(function(){$(this).prop("checked",!1)}),r.attr("hidden",""),$("#configure-permissions").removeAttr("hidden").focus()}function o(){var n=$(this),e=n.data("group-id"),t=n.find("button.edit"),a=n.find("button.delete"),i=n.find("button.ok");n.find("input").on("change",function(){var e="permission-"+$(this).data("permission-class"),t=$(this).prop("checked");n.toggleClass(e,t),t||$(this).siblings("div").find("input").each(function(){$(this).prop(t),e="permission-"+$(this).data("permission-class"),n.toggleClass(e,t)})}),t.on("expand",function(){n.addClass("edit"),n.find(".group-name").focus()}),a.on("click",function(){$("#permissions").removeClass("permission-group-"+e),n.remove()}),i.on("click",function(){n.removeClass("edit"),i.parent().removeClass("expanded"),t.attr("aria-expanded",!1).focus()})}var r=$("#permission-configuration"),t=$(".permission-rule",e),l=$("#permission-rule-template"),n=t.find("button.cancel-permission"),a=t.find("button.add-permission");n.on("click",i),a.on("click",function(){var n=$(l.html()),e=$("#current-permissions ul"),t=r.find("option:selected"),a=t.val();r.find("input").each(function(){var e=$(this),t=e.prop("checked");t&&n.addClass("permission-"+e.data("permission-class").replace(/_/g,"-")),n.find("input#"+e.attr("id")).prop("checked",t).attr("id",e.attr("id")+a).attr("name",e.attr("name")+a).next("label").attr("for",e.attr("id"))}),n.appendTo(e),n.attr("data-group-id",a),$("#permissions").addClass("permission-group-"+a),n.find(".group-name").text(t.text()),n.find("button.edit").on("click",g),o.call(n),i()}),$("#configure-permissions").on("click",function(){var t=$("#permissions"),n=!1;$("#permission-configuration").find("option").each(function(){var e=$(this);e.removeAttr("disabled"),t.hasClass("permission-group-"+e.val())?e.attr("disabled",""):n||(e.attr("selected",""),n=!0)}),$(this).attr("hidden",""),$("#permission-configuration").removeAttr("hidden"),$(this).parent().find("h4").focus()}),$("#current-permissions .permission").each(o)},login:function(){$(".remember-me").each(function(){var t=$(this).find("input:checkbox");t.on("change",function(){var e=t.is(":checked");t.toggleClass("remember--checked",e)})}),$(".show-password").each(function(){var t=$(this).find("input:checkbox"),n=document.querySelector("input[name=password]");t.on("change",function(){var e=t.is(":checked");t.toggleClass("show_password--checked",e),n.type=e?"text":"password"})})},metric:function(){$("#modal_metric").on("show.bs.modal",function(e){var t=$(e.relatedTarget),n=t.data("metric_id");$("#metric_id").val(n),n?$("#delete_metric").show():$("#delete_metric").hide();var a=t.data("target_value");$("#target_value").val(a);var i=t.data("x_axis_value");$("#x_axis_value").val(i);var o=t.data("y_axis_grouping_value");$("#y_axis_grouping_value").val(o)})},purge:function(){$("#selectall").click(function(){$(".record_selected").prop("checked",this.checked)})},system:function(){P()},user:function(e){ge(e),$(document).on("click",".cloneme-user",function(){var e=$(this).parents(".limit-to-view");e.clone().removeAttr("id").insertAfter(e)}),$(document).on("click",".removeme-user",function(){var e=$(this).parents(".limit-to-view");0<e.siblings(".limit-to-view").length&&e.remove()})}},function(e){var t,n,a;t=e,null===(a=$("body").data("page").match(/^(.*?)(:?\/\d+)?$/))||void 0!==(n=he[a[1]])&&n(t)}),ye=function(e){$("input, text",e).placeholder()},_e=function(e){$('[data-toggle="popover"]',e).popover({placement:"auto",html:!0})},we=function(e){var t;t=e,$("#selectall",t).click(function(){$(".record_selected",t).prop("checked",this.checked)})},ke=function(e){$(".record-popup",e).on("click",function(){var e=$(this).data("record-id"),t=$("#readmore_modal"),n=t.find(".modal-body");n.text("Loading..."),n.load("/record_body/"+e,null,function(){ve(n)}),t.modal(),event.stopPropagation()})},xe=function(e){$(".edit-form",e).on("submit",function(){var e=$(document.activeElement);e.prop("disabled",!0),e.prop("name")&&e.after('<input type="hidden" name="'+e.prop("name")+'" value="'+e.val()+'" />')})},Te=function(e){var i,t;$("#modal_sendemail",e).on("show.bs.modal",function(e){var t=$(e.relatedTarget).data("peopcol_id");$("#modal_sendemail_peopcol_id").val(t)}),i=e,$("#modal_helptext",i).on("show.bs.modal",function(e){var t=$(e.relatedTarget),n=t.data("col_name");$("#modal_helptext",i).find(".modal-title").text(n);var a=t.data("col_id");$.get("/helptext/"+a,function(e){$("#modal_helptext",i).find(".modal-body").html(e)})}),t=e,$("#data-table",t).length&&$("#data-table",t).floatThead({floatContainerCss:{},zIndex:function(){return 999},ariaLabel:function(e,t){return t.data("thlabel")}}),u()},je=function(e){var t,n;t=e,$("#modalnewtitle",t).on("hidden.bs.modal",function(){$("#newtitle",t).val("")}),$("#modalneworganisation",t).on("hidden.bs.modal",function(){$("#neworganisation",t).val("")}),n=e,$(document,n).on("click",".cloneme",function(){var e=$(this).parents(".limit-to-view");e.clone().removeAttr("id").insertAfter(e)}),$(document,n).on("click",".removeme",function(){var e=$(this).parents(".limit-to-view");0<e.siblings(".limit-to-view").length&&e.remove()})},Ce=function(e){var t,n,a,i,o,r,l;t=e,$(".col_check",t).length&&$("#selectall",t).click(function(e){$(".col_check",t).prop("checked",e.currentTarget.checked)}),n=e,$("#global",n).change(function(e){$("#group_id_div",n).toggle(e.currentTarget.checked)}).change(),(a=$("div#sorts",e)).length&&(a.on("click",".closeme",function(e){$(".request-row").length<1||$(e.currentTarget).parents(".request-row").remove()}),a.on("click",".add",function(e){$(e.currentTarget).parents(".sort-add").before(a.data("sortrow"))})),(i=$("div#groups",e)).length&&(i.on("click",".closeme",function(e){$(".request-row").length&&$(e.currentTarget).parents(".request-row").remove()}),i.on("click",".add",function(e){$(e.currentTarget).parents(".group-add").before(i.data("grouprow"))})),(r=$("#builder",e)).length&&r.data("use-json")&&(o=base64.decode(r.data("base-filter")),r.queryBuilder("setRules",JSON.parse(o))),l=e,$("#saveview",l).click(function(){var e=$("#builder",l).queryBuilder("getRules");$("#filter",l).val(JSON.stringify(e,null,2))})};window.Linkspace={constants:{ARROW_LEFT:37,ARROW_RIGHT:39},init:function(e){n(e),o(e),p(e),f(e),w(e),C(e),S(e),q(e),R(e),P(e),I(e),F(e),J(e),G(e),U(e),be(e),ye(e),_e(e),we(e),ke(e),O(e),xe(e),Te(e),je(e),Ce(e)},debug:function(e){"undefined"!=typeof console&&console.debug&&console.debug("[LINKSPACE]",e)},error:function(e){"undefined"!=typeof console&&console.error&&console.error("[LINKSPACE]",e)}},window.Linkspace.init()}();
